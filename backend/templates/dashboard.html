<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background-color: #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-error { background-color: #ef4444; }
        .status-pending { background-color: #6b7280; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <h1 class="text-2xl font-bold text-gray-900">{{ title }}</h1>
                        <div id="connection-status" class="ml-4 flex items-center">
                            <div class="status-indicator status-pending"></div>
                            <span class="text-sm text-gray-600">Connecting...</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="retry-failed" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                            Retry Failed
                        </button>
                        <button id="clear-completed" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                            Clear Completed
                        </button>
                        <button id="add-strategic" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                            Add Strategic URLs
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Overview Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Total Jobs</p>
                            <p id="total-jobs" class="text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Success Rate</p>
                            <p id="success-rate" class="text-2xl font-semibold text-gray-900">0%</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Avg. Time</p>
                            <p id="avg-time" class="text-2xl font-semibold text-gray-900">0s</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Active Jobs</p>
                            <p id="active-jobs" class="text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Success Rate Chart -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Success Rate Trend</h3>
                    <canvas id="success-chart" width="400" height="200"></canvas>
                </div>

                <!-- Quality Score Chart -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Quality Scores</h3>
                    <canvas id="quality-chart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Jobs Table -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Recent Jobs</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URL</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quality</th>
                            </tr>
                        </thead>
                        <tbody id="jobs-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Jobs will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Alerts -->
            <div id="alerts-container" class="mt-6">
                <!-- Alerts will be populated here -->
            </div>
        </main>
    </div>

    <script>
        // WebSocket connection
        let ws = null;
        let reconnectInterval = null;
        let successChart = null;
        let qualityChart = null;
        let successData = [];
        let qualityData = [];

        // Initialize WebSocket
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/dashboard`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                console.log('WebSocket connected');
                updateConnectionStatus('connected');
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function(event) {
                console.log('WebSocket disconnected');
                updateConnectionStatus('disconnected');
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(initWebSocket, 5000);
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus('error');
            };
        }

        // Update connection status
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connection-status');
            const indicator = statusElement.querySelector('.status-indicator');
            const text = statusElement.querySelector('span');
            
            indicator.className = 'status-indicator';
            
            switch(status) {
                case 'connected':
                    indicator.classList.add('status-success');
                    text.textContent = 'Connected';
                    break;
                case 'disconnected':
                    indicator.classList.add('status-pending');
                    text.textContent = 'Disconnected';
                    break;
                case 'error':
                    indicator.classList.add('status-error');
                    text.textContent = 'Error';
                    break;
                default:
                    indicator.classList.add('status-pending');
                    text.textContent = 'Connecting...';
            }
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'dashboard_update':
                case 'periodic_update':
                    updateDashboard(data);
                    break;
                case 'job_added':
                    console.log('Job added:', data.data);
                    break;
                case 'job_started':
                    console.log('Job started:', data.data);
                    break;
                case 'job_completed':
                    console.log('Job completed:', data.data);
                    break;
            }
        }

        // Update dashboard with new data
        function updateDashboard(data) {
            if (data.stats) {
                updateStats(data.stats);
            }
            if (data.jobs) {
                updateJobsTable(data.jobs);
            }
            if (data.quality) {
                updateQualityChart(data.quality);
            }
        }

        // Update statistics
        function updateStats(stats) {
            document.getElementById('total-jobs').textContent = stats.total_jobs || 0;
            document.getElementById('success-rate').textContent = 
                stats.success_rate ? `${(stats.success_rate * 100).toFixed(1)}%` : '0%';
            document.getElementById('avg-time').textContent = 
                stats.avg_extraction_time ? `${stats.avg_extraction_time.toFixed(1)}s` : '0s';
            document.getElementById('active-jobs').textContent = stats.active_jobs_count || 0;
        }

        // Update jobs table
        function updateJobsTable(jobs) {
            const tbody = document.getElementById('jobs-table-body');
            tbody.innerHTML = '';
            
            const allJobs = [...(jobs.active || []), ...(jobs.completed || [])];
            const recentJobs = allJobs.slice(-10).reverse();
            
            recentJobs.forEach(job => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${job.id}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="max-w-xs truncate" title="${job.url}">
                            ${job.url}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${job.source_name}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(job.status)}">
                            ${job.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${job.completed_at ? formatTime(job.completed_at) : 'Running...'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${job.result && job.result.quality_score ? 
                            `${(job.result.quality_score * 100).toFixed(1)}%` : 'N/A'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Get status CSS class
        function getStatusClass(status) {
            switch(status) {
                case 'success': return 'bg-green-100 text-green-800';
                case 'failed': return 'bg-red-100 text-red-800';
                case 'in_progress': return 'bg-blue-100 text-blue-800';
                case 'retrying': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Format time
        function formatTime(timeString) {
            const date = new Date(timeString);
            return date.toLocaleTimeString();
        }

        // Initialize charts
        function initCharts() {
            // Success Rate Chart
            const successCtx = document.getElementById('success-chart').getContext('2d');
            successChart = new Chart(successCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Success Rate',
                        data: [],
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });

            // Quality Chart
            const qualityCtx = document.getElementById('quality-chart').getContext('2d');
            qualityChart = new Chart(qualityCtx, {
                type: 'bar',
                data: {
                    labels: ['Title', 'Summary', 'Region', 'Topics', 'Date'],
                    datasets: [{
                        label: 'Quality Score',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
        }

        // Update quality chart
        function updateQualityChart(qualityData) {
            if (qualityData.field_performance && qualityChart) {
                const performance = qualityData.field_performance;
                const fields = ['title', 'summary', 'region', 'topics', 'publish_date'];
                const scores = fields.map(field => 
                    performance[field] ? performance[field].avg_score : 0
                );
                
                qualityChart.data.datasets[0].data = scores;
                qualityChart.update();
            }
        }

        // Button event listeners
        document.getElementById('retry-failed').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/dashboard/retry-failed', { method: 'POST' });
                const result = await response.json();
                console.log('Retry result:', result);
            } catch (error) {
                console.error('Error retrying failed jobs:', error);
            }
        });

        document.getElementById('clear-completed').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/dashboard/clear-completed', { method: 'POST' });
                const result = await response.json();
                console.log('Clear result:', result);
            } catch (error) {
                console.error('Error clearing completed jobs:', error);
            }
        });

        document.getElementById('add-strategic').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/dashboard/strategic-urls', { method: 'POST' });
                const result = await response.json();
                console.log('Strategic URLs result:', result);
            } catch (error) {
                console.error('Error adding strategic URLs:', error);
            }
        });

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            initWebSocket();
            
            // Load initial data
            fetch('/api/dashboard/overview')
                .then(response => response.json())
                .then(data => updateDashboard(data))
                .catch(error => console.error('Error loading initial data:', error));
        });
    </script>
</body>
</html>
